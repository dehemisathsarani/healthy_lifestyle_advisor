<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Test - 3 Users</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f9f9f9;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .summary {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ Login System Test - 3 Users</h1>
    <p>Testing the login functionality for all 3 users in the system.</p>
    
    <div class="user-card">
        <h3>üë§ Demo User</h3>
        <p><strong>Email:</strong> demo@example.com</p>
        <p><strong>Password:</strong> demo12345</p>
        <button class="test-btn" onclick="testLogin('demo@example.com', 'demo12345', 'demo-result')">Test Login</button>
        <div id="demo-result" class="result" style="display:none;"></div>
    </div>

    <div class="user-card">
        <h3>üë®‚Äçüíº Test Admin</h3>
        <p><strong>Email:</strong> admin@healthagent.com</p>
        <p><strong>Password:</strong> admin123</p>
        <button class="test-btn" onclick="testLogin('admin@healthagent.com', 'admin123', 'admin-result')">Test Login</button>
        <div id="admin-result" class="result" style="display:none;"></div>
    </div>

    <div class="user-card">
        <h3>üë®‚Äçüíª John Smith</h3>
        <p><strong>Email:</strong> john.smith@example.com</p>
        <p><strong>Password:</strong> john2024</p>
        <button class="test-btn" onclick="testLogin('john.smith@example.com', 'john2024', 'john-result')">Test Login</button>
        <div id="john-result" class="result" style="display:none;"></div>
    </div>

    <div class="user-card">
        <h3>üîÑ Batch Test</h3>
        <p>Test all users at once</p>
        <button class="test-btn" onclick="testAllUsers()">Test All Users</button>
        <button class="test-btn" onclick="checkUsers()">Check Database Users</button>
        <div id="batch-result" class="result" style="display:none;"></div>
    </div>

    <div id="summary" class="summary" style="display:none;">
        <h3>üìä Test Summary</h3>
        <div id="summary-content"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let testResults = [];

        async function testLogin(email, password, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = '‚è≥ Testing login...';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ Login Successful!</strong><br>
                        <strong>User:</strong> ${data.user.name}<br>
                        <strong>Email:</strong> ${data.user.email}<br>
                        <strong>Token:</strong> ${data.accessToken.substring(0, 50)}...<br>
                        <details>
                            <summary>Full Response</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                    
                    // Test the /auth/me endpoint with the token
                    await testProtectedEndpoint(data.accessToken, resultId);
                    
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå Login Failed!</strong><br>
                        <strong>Status:</strong> ${response.status}<br>
                        <strong>Error:</strong> ${data.detail || 'Unknown error'}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
                
                updateTestResults(email, response.ok, data);
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Network Error!</strong><br>
                    <strong>Error:</strong> ${error.message}
                `;
                updateTestResults(email, false, { error: error.message });
            }
        }

        async function testProtectedEndpoint(token, resultId) {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                const resultDiv = document.getElementById(resultId);
                
                if (response.ok) {
                    resultDiv.innerHTML += `<br><strong>‚úÖ Protected Endpoint Test:</strong> Success<br>
                        <strong>Profile:</strong> ${data.name} (${data.email})`;
                } else {
                    resultDiv.innerHTML += `<br><strong>‚ùå Protected Endpoint Test:</strong> Failed<br>
                        <strong>Error:</strong> ${data.detail || 'Unknown error'}`;
                }
            } catch (error) {
                const resultDiv = document.getElementById(resultId);
                resultDiv.innerHTML += `<br><strong>‚ùå Protected Endpoint Error:</strong> ${error.message}`;
            }
        }

        function updateTestResults(email, success, data) {
            const existingIndex = testResults.findIndex(r => r.email === email);
            const result = { email, success, data, timestamp: new Date() };
            
            if (existingIndex >= 0) {
                testResults[existingIndex] = result;
            } else {
                testResults.push(result);
            }
            
            updateSummary();
        }

        function updateSummary() {
            if (testResults.length === 0) return;
            
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            const successCount = testResults.filter(r => r.success).length;
            const totalCount = testResults.length;
            
            summaryContent.innerHTML = `
                <p><strong>Total Tests:</strong> ${totalCount}</p>
                <p><strong>Successful:</strong> ${successCount}</p>
                <p><strong>Failed:</strong> ${totalCount - successCount}</p>
                <p><strong>Success Rate:</strong> ${((successCount / totalCount) * 100).toFixed(1)}%</p>
                ${successCount === totalCount ? '<p style="color: green;"><strong>üéâ ALL TESTS PASSED!</strong></p>' : '<p style="color: red;"><strong>‚ö†Ô∏è Some tests failed</strong></p>'}
            `;
            
            summaryDiv.style.display = 'block';
        }

        async function testAllUsers() {
            const users = [
                { email: 'demo@example.com', password: 'demo12345', id: 'demo-result' },
                { email: 'admin@healthagent.com', password: 'admin123', id: 'admin-result' },
                { email: 'john.smith@example.com', password: 'john2024', id: 'john-result' }
            ];
            
            const batchResult = document.getElementById('batch-result');
            batchResult.style.display = 'block';
            batchResult.className = 'result loading';
            batchResult.innerHTML = '‚è≥ Testing all users...';
            
            for (const user of users) {
                await testLogin(user.email, user.password, user.id);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            batchResult.className = 'result success';
            batchResult.innerHTML = '‚úÖ Batch test completed! Check individual results above.';
        }

        async function checkUsers() {
            const batchResult = document.getElementById('batch-result');
            batchResult.style.display = 'block';
            batchResult.className = 'result loading';
            batchResult.innerHTML = '‚è≥ Checking database users...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/debug/users`);
                const data = await response.json();
                
                if (response.ok) {
                    batchResult.className = 'result success';
                    batchResult.innerHTML = `
                        <strong>‚úÖ Database Users (${data.count}):</strong><br>
                        <pre>${JSON.stringify(data.users, null, 2)}</pre>
                    `;
                } else {
                    batchResult.className = 'result error';
                    batchResult.innerHTML = `‚ùå Failed to fetch users: ${data.detail || 'Unknown error'}`;
                }
            } catch (error) {
                batchResult.className = 'result error';
                batchResult.innerHTML = `‚ùå Network error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
